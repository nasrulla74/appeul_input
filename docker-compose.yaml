version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: appeul_backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - AI_PROVIDER=${AI_PROVIDER:-deepseek}
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=${ALGORITHM}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.appeul-backend.rule=PathPrefix(`/auth`, `/invoices`, `/users`, `/settings`)"
      - "traefik.http.routers.appeul-backend.entrypoints=websecure"
      - "traefik.http.routers.appeul-backend.tls=true"
      - "traefik.http.services.appeul-backend.loadbalancer.server.port=8000"
      - "traefik.docker.network=coolify"
    networks:
      - coolify
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: appeul_frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.appeul-frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.appeul-frontend.entrypoints=websecure"
      - "traefik.http.routers.appeul-frontend.tls=true"
      - "traefik.http.services.appeul-frontend.loadbalancer.server.port=80"
      - "traefik.docker.network=coolify"
    networks:
      - coolify
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  coolify:
    external: true
